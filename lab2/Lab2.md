# Лабораторная работа 2.1 Динамические соединения с базами данных

# Цель

Получить практические навыки создания сложного ETL-процесса, включающего динамическую загрузку файлов по HTTP, нормализацию базы данных, обработку дубликатов и настройку обработки ошибок с использованием Pentaho Data Integration (PDI).

# Шаг 1. Подготовка базы данных

Создадим структуру таблиц в базе данных.

Таблица заказов:

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-21%20200759.png" />

Таблица клиентов:

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-21%20200817.png" />

Таблица продуктов:

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-21%20200831.png" />

Индексы и настройка кодировки:

<img width="1000" height="700" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-21%20200852.png" />

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-21%20200928.png" />

# Шаг 2. Выполнение основного задания

## Настройка JOB

1. Set Variables: Создайте переменную пути к файлу.

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234846.png" />

2. Check File Exists: Проверка наличия файла ${CSV_FILE_PATH}.

<img width="400" height="250" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234912.png" />
  
3. HTTP (Download): Загрузка файла, если его нет.

<img width="1000" height="400" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234923.png" />

4. Transformation. Последовательный вызов трех трансформаций для загрузки данных.
   
Итоговая схема:

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20151116.png" />

## Реализация Трансформаций

Трансформация 1. Load Orders

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234014.png" />

Трансформация 2. Load Customers

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20144616.png" />

Трансформация 3. Load Products

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20144842.png" />

## Запуск JOB

Запустим JOB и перейдем в базу данных, чтобы проверить, что данные были загружены:

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20144425.png" />

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20144627.png" />

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20144857.png" />

# Шаг 3. Индивидуальное задание

Вариант №12:

-Основной фильтр: Срок доставки > 5 дней 

-Отчет по прибыли

-Анализ продаж

## Фильтр

Для того, чтобы выполнить это задание, дополним трансформацию Orders. Сначала создадим с помощью компонента Calculator новую переменную delivery_time, которая будет вычисляться по формуле: дата доставки - дата заказа:

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20233959.png" />

Затем создадим новый компонент Filter Rows и поставим условие, что время доставки должно быть больше 5 дней:

<img width="600" height="400" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234008.png" />

Запустим трансформацию:

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20181356.png" />

Проверим с помощью sql-запроса. Узнаем, сколько строк в таблице Orders, у которых разница между ship_date и order_date составляет меньше 5:

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20181434.png" />

Видим, что таких строк 0, значит фильтр отработал корректно

## Отчет по прибыли

Для удобства создадим новую трансформацию:

<img width="1000" height="400" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234021.png" />

Настройка компонентов:

1. Укажем путь к нужному файлу

<img width="800" height="600" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225708.png" />

2. Зададим корректные названия столбцов

<img width="1000" height="600" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225721.png" />

3. Выберем нужные для анализа столбцы

<img width="600" height="350" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225731.png" />

4. Отфильтруем строки, в которых пропущены значения столбцов profit и sales

<img width="600" height="350" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225741.png" />

5. Расчитаем новый показатель - рентабельность сделки, а также создадим столбцы year и month для удобства анализа по временным периодам

<img width="1000" height="350" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225750.png" />

6. Загрузим данные в таблицу profit_report

<img width="800" height="350" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225759.png" />

Создадим таблицу profit_report:

<img width="816" height="401" alt="image" src="https://github.com/user-attachments/assets/a10b215e-d1c1-40a1-a30a-48126bfbc805" />

Выполним трансформацию:

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20183841.png" />

<img width="1306" height="873" alt="image" src="https://github.com/user-attachments/assets/3c9c99fb-9805-4d83-ae03-e1fe1b0ca51f" />

## Анализ продаж

Также создадим новую трансформацию:

<img width="1000" height="400" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234021.png" />

Настройка компонентов:

1. Укажем путь к нужному файлу

<img width="800" height="600" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225708.png" />

2. Зададим корректные названия столбцов

<img width="1000" height="600" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225721.png" />

3. Выберем нужные для анализа столбцы

<img width="600" height="350" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225818.png" />

4. Отфильтруем строки, в которых пропущены значения столбца sales

<img width="600" height="350" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225831.png" />

5. Заменим значения в столбце returned

<img width="600" height="350" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225839.png" />

6. Расчитаем новые показатели исходя из даты заказа - год, месяц, день недели
   
<img width="1000" height="350" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225905.png" />

7. Рассчитаем показатели рентабельность сделки и цена за единицу товара:

<img width="1000" height="350" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225925.png" />

8.  Загрузим данные в таблицу sales_analysis

<img width="800" height="350" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225759.png" />

Создадим таблицу sales_analysis:

<img width="888" height="519" alt="image" src="https://github.com/user-attachments/assets/83b6c56c-b2f3-44b1-8342-e2a9e0922ec1" />

Выполним трансформацию:

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20185437.png" />

<img width="1598" height="896" alt="image" src="https://github.com/user-attachments/assets/5b4667e7-05cd-4fc4-9127-25c5df134e78" />

## Изменения в JOB

Добавим созданные трансформации в JOB и запустим его:

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225306.png" />

Видим, что JOB выполнен успешно, все трансформации запущены, данные загружены в базу данных. Перейдем к анализу

## Анализ данных был произведен с помощью Python

Файл с анализом:

## Результаты анализа

#### Отчет по прибыли:

<img width="1990" height="1377" alt="image" src="https://github.com/user-attachments/assets/0a5a06e0-638b-4700-8a3c-9460d3675f80" />

Выводы:

- За анализируемый период наблюдается устойчивый рост прибыли
- Пиковые месяцы по объему прибыли - март, сентябрь, декабрь. Месяцы спада - январь, апрель, июль. Явно выраженная сезонность не наблюдается
- Самая нерентабельная категория - мебель
- Город, в котором филиал компании получает наибольшую прибыль, - Нью Йорк 

#### Анализ продаж:

<img width="2390" height="2357" alt="image" src="https://github.com/user-attachments/assets/36d51a12-4635-4378-bf67-36a8a8a73321" />

Выводы:

- Продажи значительно падают к концу недели (с пятницы по воскресенье)
- Доля продаж выше всего в филиале в Нью Йорке
- Лучший менеджер по объему продаж - Анна
- Процент возвратов выше у категории - канцелярские товары
- Почти 20% сделок нерентабельны (затраты превышают выручку)

# Выводы

В ходе выполнения лабораторной работы были получены навыки создания JOB - сложного ETL-процесса. Индидуальные задания были выполнены в полном объеме: реализованы две новые трансформации и выполнен анализ в Python.
