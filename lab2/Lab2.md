# Лабораторная работа 2.1 Динамические соединения с базами данных

# Шаг 1. Подготовка базы данных

Создадим структуру таблиц в базе данных.

Таблица заказов:

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-21%20200759.png" />

Таблица клиентов:

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-21%20200817.png" />

Таблица продуктов:

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-21%20200831.png" />

Индексы и настройка кодировки:

<img width="1000" height="700" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-21%20200852.png" />

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-21%20200928.png" />

# Шаг 2. Выполнение основного задания

## Настройка JOB

1. Set Variables: Создайте переменную пути к файлу.

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234846.png" />

2. Check File Exists: Проверка наличия файла ${CSV_FILE_PATH}.

<img width="400" height="250" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234912.png" />
  
3. HTTP (Download): Загрузка файла, если его нет.

<img width="1000" height="400" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234923.png" />

4. Transformation. Последовательный вызов трех трансформаций для загрузки данных.
   
Итоговая схема:

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20151116.png" />

## Реализация Трансформаций

Трансформация 1. Load Orders

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234014.png" />

Трансформация 2. Load Customers

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20144616.png" />

Трансформация 3. Load Products

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20144842.png" />

## Запуск JOB

Запустим JOB и перейдем в базу данных, чтобы проверить, что данные были загружены:

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20144425.png" />

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20144627.png" />

<img width="1000" height="800" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20144857.png" />

# Шаг 3. Индивидуальное задание

Вариант №12:
-Основной фильтр: Срок доставки > 5 дней 
-Отчет по прибыли
-Анализ продаж

## Фильтр

Для того, чтобы выполнить это задание, дополним трансформацию Orders. Сначала создадим с помощью компонента Calculator новую переменную delivery_time, которая будет вычисляться по формуле: дата доставки - дата заказа:

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20233959.png" />

Затем создадим новый компонент Filter Rows и поставим условие, что время доставки должно быть больше 5 дней:

<img width="600" height="400" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234008.png" />

Запустим трансформацию:

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20181356.png" />

Проверим с помощью sql-запроса. Узнаем, сколько строк в таблице Orders, у которых разница между ship_date и order_date составляет меньше 5:

<img width="1000" height="500" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-22%20181434.png" />

Видим, что таких строк 0, значит фильтр отработал корректно

## Отчет по прибыли

Для удобства создадим новую трансформацию:

<img width="1000" height="400" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20234021.png" />

Настройка компонентов:

1. Укажем путь к нужному файлу

<img width="600" height="600" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225708.png" />

2. Зададим корректные названия столбцов

<img width="1000" height="600" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225721.png" />

3. Выберем нужные для анализа столбцы

<img width="400" height="300" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225731.png" />

4. Отфильтруем строки, в которых пропущены значения столбцов profit и sales

<img width="400" height="300" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225741.png" />

5. Расчитаем новый показатель - рентабельность сделки, а также создадим столбцы year и month для удобства анализа по временным периодам

<img width="1000" height="300" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225750.png" />

6. Загрузим данные в таблицу profit_report

<img width="600" height="300" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225759.png" />

Создадим таблицу profit_report:

<img width="600" height="300" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225759.png" />

Выполним трансформацию:

<img width="600" height="300" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225759.png" />

<img width="600" height="300" alt="image" src="/lab2/images/Снимок%20экрана%202026-02-23%20225759.png" />

## Анализ продаж
